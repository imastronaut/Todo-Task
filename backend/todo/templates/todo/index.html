{% extends "todo/layout.html" %}

{% block title %}
    TodoApp
{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
{% endblock %}

{% block body %}
    <div class="container">
        Hello {{request.user.username}}
        <a href="{% url 'logout' %}">Logout</a>
        <div id="newtask">
            <form onsubmit="event.preventDefault(); handleSubmit(event);">
                {% csrf_token %}
                <input type="text"  name="input" id="newtask-input" placeholder="Type your todo">
                <input type="submit" id="add" value="Add">
            </form>
        </div>
        <div id="tasks">

        </div>
    </div>

    <script>
        // const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken');
        const handleSubmit =async(e) =>{      
            if(document.querySelector("#newtask-input").value.length === 0){
                 alert("Type something!")
            }
            let response = await fetch("todos/", {
                method:"POST",
                headers:{
                    "Content-type":"application/json",
                    "X-CSRFToken" : e.target.csrfmiddlewaretoken.value

                },
                body:JSON.stringify({"body":e.target.input.value})
            })
            let data = await response.json()
            add_todo(data)
            document.querySelector("#newtask-input").value="";
            
            }

            
            
       const displayTodo = (data)=>{
            {data.map((entry)=>add_todo(entry))}
        }

        const getTodos = async()=>{
            let response = await fetch("todos/",{
                method:"GET",
                headers:{
                    "Content-type":"application/json",
                    "X-CSRFToken" : csrftoken
                },
            })
            let data = await response.json()   
            console.log(data)
            displayTodo(data)
        }
        getTodos()
        
        function add_todo(entry){
            document.querySelector("#tasks").innerHTML+=
            `<div class="task">
                <input type="checkbox" id = "input${entry.id}" onchange='completeItem(${entry.id})'>
                <label for="input${entry.id}" id="label${entry.id}">${entry.body}</label>
                <button class="delete" onclick='handleDelete(${entry.id}); this.parentNode.remove();'>
                        <i class="fa-solid fa-trash"></i>
                </button>
            </div>`;
            if(entry.completed){
                // console.log(document.getElementById(`#label${entry.id}`).value)
                function check(){
                    document.querySelector(`#input${entry.id}`).checked = true
                }
                check()
                document.querySelector(`#label${entry.id}`).style.textDecoration = "line-through";
            }else{
                
            }
        }

        const handleDelete = async(id)=>{
            let response = await fetch(`todo/${id}`,{
                method:"DELETE",
                headers:{
                    "Content-type":"application/json",
                    "X-CSRFToken" : csrftoken
                }
            })
            let data = await response.json()
        }
        
        

        const completeItem = async(id)=>{
            console.log(document.querySelector(`#input${id}`).checked)
            let response = await fetch(`todo/${id}`,{
                method:"PATCH",
                headers:{
                    "Content-type":"application/json",
                    "X-CSRFToken": csrftoken
                },
                body:JSON.stringify({"completed":document.querySelector(`#input${id}`).checked})
            })
            let data = await response.json()
            console.log(data)
            if(data.completed){
                document.querySelector(`#label${id}`).style.textDecoration = "line-through";
            }else{
                document.querySelector(`#label${id}`).style.textDecoration = "none"; 
            }
        }

    </script>
{% endblock %}